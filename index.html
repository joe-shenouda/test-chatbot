<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenGPT 4o Chatbot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.0.3/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .message {
            max-width: 70%;
        }
        .user-message {
            background-color: #e2e8f0;
        }
        .bot-message {
            background-color: #edf2f7;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ChatMessage = ({ message, isUser }) => {
            const messageClass = isUser ? "user-message ml-auto" : "bot-message";
            return (
                <div className={`message ${messageClass} rounded-lg p-3 mb-4 shadow`}>
                    <div dangerouslySetInnerHTML={{ __html: marked(message) }} />
                </div>
            );
        };

        const ChatBot = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const chatContainerRef = useRef(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!input.trim()) return;

                const userMessage = input;
                setMessages(prev => [...prev, { text: userMessage, isUser: true }]);
                setInput("");
                setIsLoading(true);

                try {
                    const response = await axios.post('/api/chat', { message: userMessage });
                    setMessages(prev => [...prev, { text: response.data.reply, isUser: false }]);
                } catch (error) {
                    console.error('Error:', error);
                    setMessages(prev => [...prev, { text: "Sorry, I encountered an error. Please try again.", isUser: false }]);
                }

                setIsLoading(false);
            };

            useEffect(() => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [messages]);

            return (
                <div className="container mx-auto p-4">
                    <h1 className="text-3xl font-bold mb-4 text-center">OpenGPT 4o Chatbot</h1>
                    <div className="chat-container bg-white rounded-lg shadow p-4 mb-4" ref={chatContainerRef}>
                        {messages.map((message, index) => (
                            <ChatMessage key={index} message={message.text} isUser={message.isUser} />
                        ))}
                        {isLoading && (
                            <div className="bot-message rounded-lg p-3 mb-4 shadow animate-pulse">
                                OpenGPT 4o is thinking...
                            </div>
                        )}
                    </div>
                    <form onSubmit={handleSubmit} className="flex">
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            placeholder="Type your message here..."
                            className="flex-grow p-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <button
                            type="submit"
                            className="bg-blue-500 text-white p-2 rounded-r-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            Send
                        </button>
                    </form>
                </div>
            );
        };

        ReactDOM.render(<ChatBot />, document.getElementById('root'));
    </script>
</body>
</html>
